<!DOCTYPE HTML>
<html>

<head>
    <title>Edition mode Visit360</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.css" />
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.js"></script>
    <style>
        html,
        body {
            font-family: 'Trebuchet MS';
            background-color: rgb(51, 51, 51);
            color: white;
            display: block;
            height: 100vh;
            box-sizing: border-box;
            overflow: hidden;
        }

        .child1 {
            display: flex;
            height: 75px;
            width: 100%;

        }

        .child2 {
            display: flex;
            height: calc(100vh - 80px);
        }

        #button {
            width: 75px;
            height: 75px;
        }

        #header {
            background: rgb(59, 59, 59);
            width: 100%;
            padding-left: 20px;
            border-radius: 5px;
        }

        #viewer {
            width: 100%;

        }

        .scroller {
            width: 255px;
            height: calc(100vh - 115px);
            overflow-y: scroll;
            scrollbar-color: rgb(0, 255, 221) rgb(0, 255, 221);
            scrollbar-width: thin;
        }

        #selection {
            background-color: grey;

            width: 255px;

        }

        .selected {
            border: 3px solid rgb(0, 255, 221);
        }

        #toolbar {
            background-color: grey;
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 400px;
            height: 100%;
        }

        #buttons {
            display: flex;
            flex-direction: column;
            row-gap: 25px;
            width: 70%;
            padding: 25px;
        }

        .button {
            background-color: rgb(0, 255, 221);
            border: none;
            font-size: medium;
            border-radius: 5px;
            padding: 5px;

        }

        .input {
            font-size: medium;
            border-radius: 5px;

        }

        .label {
            font-size: medium;


        }

        /* Define the tooltip style */
        .tooltip {
            position: relative;
        }

        .tooltip:hover::after {
            display: block;
            transition-delay: 0.01s !important;
        }

        #addselect {
            width: auto;
            height: 30px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: flex-end;
        }

        /*==========================================================================*/
        /* POPUP */

        .popup {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            justify-content: center;
            align-items: center;
            background-color: rgba(0, 0, 0, 0.5);
        }

        /* Popup content */
        .popup-content {
            color: black;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            width: 400px;
            max-width: 90%;
        }


        /* Show popup when it is open */
        .popup.show {
            display: flex;
        }

        /* Close button */
        .close {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
        }

        /* Hover effect for close button */
        .close:hover {
            color: red;
        }

        .topbar {
            cursor: pointer;
            position: absolute;
            top: 0;
            right: 0;
            padding: 5px;
        }

        /*==========================================================================*/
        select {
            font-size: 16px;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
    </style>
</head>

<body>
    <div id="child1" class="child1">
        <div id="button">
            <button
                style="width:75px;height:75px;font-size:50px;background-color: rgb(0, 255, 221);border: none;border-radius: 5px;"
                onclick="toggleMode()">&#128065</button>
        </div>
        <div id="header">
            <h1>Edit Visit360</h1>
        </div>
        <div id="button">
            <button
                style="width:75px;height:75px;font-size:50px;background-color: rgb(0, 255, 221);border: none;border-radius: 5px;"
                onclick="gotomap()">&#9997</button>
        </div>
    </div>
    <div id="child2" class="child2">
        <div id="selection" class="column">
            <div id="addselect">
                <button id="addPano" class="button">&#43 Add Panorama</button>
            </div>
            <div class="scroller">
                <div id="image-list">

                    <div class="tooltip">
                        <img src="../content/panorama/amphi_005.jpg" title="" alt="amphi_005" width="240" height="100"
                            onclick="selectImage('amphi_005')">
                    </div>

                    <div class="tooltip">
                        <img src="../content/panorama/amphi_007.jpg" title="" alt="amphi_007" width="240" height="100"
                            onclick="selectImage('amphi_007')">
                    </div>

                    <div class="tooltip">
                        <img src="../content/panorama/couloir_1.jpg" title="" alt="couloir_1" width="240" height="100"
                            onclick="selectImage('couloir_1')">
                    </div>

                    <div class="tooltip">
                        <img src="../content/panorama/couloir_2.jpg" title="" alt="couloir_2" width="240" height="100"
                            onclick="selectImage('couloir_2')">
                    </div>

                    <div class="tooltip">
                        <img src="../content/panorama/couloir_3.jpg" title="" alt="couloir_3" width="240" height="100"
                            onclick="selectImage('couloir_3')">
                    </div>

                    <div class="tooltip">
                        <img src="../content/panorama/couloir_4.jpg" title="" alt="couloir_4" width="240" height="100"
                            onclick="selectImage('couloir_4')">
                    </div>

                    <div class="tooltip">
                        <img src="../content/panorama/couloir_5.jpg" title="" alt="couloir_5" width="240" height="100"
                            onclick="selectImage('couloir_5')">
                    </div>

                    <div class="tooltip">
                        <img src="../content/panorama/couloir_6.jpg" title="" alt="couloir_6" width="240" height="100"
                            onclick="selectImage('couloir_6')">
                    </div>

                    <div class="tooltip">
                        <img src="../content/panorama/Hall.jpg" title="" alt="Hall" width="240" height="100"
                            onclick="selectImage('Hall')">
                    </div>

                    <div class="tooltip">
                        <img src="../content/panorama/salle_009.jpg" title="" alt="salle_009" width="240" height="100"
                            onclick="selectImage('salle_009')">
                    </div>

                    <div class="tooltip">
                        <img src="../content/panorama/salle_013.jpg" title="" alt="salle_013" width="240" height="100"
                            onclick="selectImage('salle_013')">
                    </div>

                    <div class="tooltip">
                        <img src="../content/panorama/entree_domus.jpg" title="" alt="entree_domus" width="240"
                            height="100" onclick="selectImage('entree_domus')">
                    </div>

                    <div class="tooltip">
                        <img src="../content/panorama/chambre_domus.jpg" title="" alt="chambre_domus" width="240"
                            height="100" onclick="selectImage('chambre_domus')">
                    </div>

                    <div class="tooltip">
                        <img src="../content/panorama/salle_chaise_domus.jpg" title="" alt="salle_chaise_domus"
                            width="240" height="100" onclick="selectImage('salle_chaise_domus')">
                    </div>

                    <div class="tooltip">
                        <img src="../content/panorama/salle_de_bain_domus.jpg" title="" alt="salle_de_bain_domus"
                            width="240" height="100" onclick="selectImage('salle_de_bain_domus')">
                    </div>

                    <div class="tooltip">
                        <img src="../content/panorama/acceuil_fablab.jpg" title="" alt="acceuil_fablab" width="240"
                            height="100" onclick="selectImage('acceuil_fablab')">
                    </div>

                    <div class="tooltip">
                        <img src="../content/panorama/box_1_fablab.jpg" title="" alt="box_1_fablab" width="240"
                            height="100" onclick="selectImage('box_1_fablab')">
                    </div>

                    <div class="tooltip">
                        <img src="../content/panorama/box_2_fablab.jpg" title="" alt="box_2_fablab" width="240"
                            height="100" onclick="selectImage('box_2_fablab')">
                    </div>

                    <div class="tooltip">
                        <img src="../content/panorama/box_3_fablab.jpg" title="" alt="box_3_fablab" width="240"
                            height="100" onclick="selectImage('box_3_fablab')">
                    </div>

                    <div class="tooltip">
                        <img src="../content/panorama/entree_fablab.jpg" title="" alt="entree_fablab" width="240"
                            height="100" onclick="selectImage('entree_fablab')">
                    </div>

                    <div class="tooltip">
                        <img src="../content/panorama/open_space_fablab.jpg" title="" alt="open_space_fablab"
                            width="240" height="100" onclick="selectImage('open_space_fablab')">
                    </div>

                    <div class="tooltip">
                        <img src="../content/panorama/salle_decoupeuse_laser_fablab.jpg" title=""
                            alt="salle_decoupeuse_laser_fablab" width="240" height="100"
                            onclick="selectImage('salle_decoupeuse_laser_fablab')">
                    </div>

                    <div class="tooltip">
                        <img src="../content/panorama/salle_imprimante_3D_fablab.jpg" title=""
                            alt="salle_imprimante_3D_fablab" width="240" height="100"
                            onclick="selectImage('salle_imprimante_3D_fablab')">
                    </div>

                </div>
            </div>
        </div>
        <div id="viewer" class="column">
            <div id="panorama"></div>
        </div>

        <div id="toolbar" class="column">
            <div id="buttons">
                <button id="information" class="button">&#9432 Add Information</button>
                <button id="gateway" class="button">&#129145 Add Gateway</button>
                <button id="deleteHotspot" class="button">&#10060 Delete Hotspot</button>
                <button id="ExportScene" class="button">&#129124 &#128194 Export Visit</button>
                <button id="importVisit" class="button">&#129126 &#128194 Import Visit</button>
                <button id="clearVisit" class="button">&#129126 &#128194 Clear Visit</button>
            </div>
        </div>
        <div id="popups">

            <div id="panoInfo" class="popup">
                <div class="popup-content">
                    <div class="topbar">
                        <span class="closePano">&#10060</span>
                    </div>
                    <label for="name" class="label">Scene ID :</label>
                    <input type="text" id="endScenePano" name="endScenePano" class="input" required>
                    <button id="submitButtonPano" class="button">Submit</button>
                </div>
            </div>

            <div id="gatewayInfo" class="popup">
                <div class="popup-content">
                    <div class="topbar">
                        <span class="closeGatewayInfo">&#10060</span>
                    </div>
                    <label for="name" class="label">Next Scene ID :</label>
                    <input type="text" id="endSceneId" name="endSceneId" class="input" required>
                    <label for="name" class="label">Gateway Text :</label>
                    <input type="text" id="gatewayText" name="gatewayText" class="input" required>
                    <button id="submitButton" class="button">Submit</button>
                </div>
            </div>
            <div id="hotspotInfoDesc" class="popup">
                <div class="popup-content">
                    <div class="topbar">
                        <span class="closeInfoDesc">&#10060</span>
                    </div>

                    <label for="name" class="label">Description :</label>
                    <input type="text" id="infoText" name="infoText" class="input" required>
                    <button id="submitButtonInfo" class="button">Submit</button>
                </div>
            </div>



            <div id="importVisitDesc" class="popup">
                <div class="popup-content">
                    <div class="topbar">
                        <span class="closeImportInfo">&#10060</span>
                    </div>
                    <select>
                        <option value="Polytech">Polytech</option>
                        <option value="Fablab">Fablab</option>
                        <option value="Domus">Domus</option>
                    </select>
                    <br>
                    <button id="submitButtonImport" class="button">Import</button>
                </div>
            </div>



        </div>

    </div>

    <script>


        var initialConfig =
        {
            "default": {
                "firstScene": "hall",
                "sceneFadeDuration": 2000,
                "hotSpotDebug": true
            },

            "scenes": {
                "hall": {
                    "title": "Hall Polytech",
                    "panorama": "../content/panorama/Hall.jpg",
                },
            },

            "autoLoad": true
        }


        //I check if there is a config_visit element in the localStorage, if yes I set that configuration,
        //Else, I create a new configuration
        if (!localStorage.getItem('alreadyOpened')) {
            var pan = pannellum.viewer('panorama', initialConfig);
            localStorage.setItem('config_visit', JSON.stringify(initialConfig))
            console.log("hello motherfucker")
            localStorage.setItem("alreadyOpened", true);
            //localStorage.removeItem('empty')
        }
        else {
            console.log(localStorage.getItem('config_visit'))
            var importedConfig_view = JSON.parse(localStorage.getItem('config_visit'));
            var pan = pannellum.viewer('panorama', importedConfig_view)
        }

        window.addEventListener('beforeunload', function (event) {
            //I check if there isn't localStorage.getItem('goToZero') because i don't want to execute the code
            //when i click the button clear Visit
            if (!localStorage.getItem('goToZero')) {
                if (pan) {
                    var configuration_visit = pan.getConfig();
                    var partialConfig_visit = {}
                    partialConfig_visit["default"] = configuration_visit.default;
                    partialConfig_visit["scenes"] = configuration_visit.scenes;
                    var textConfig = JSON.stringify(partialConfig_visit);
                    localStorage.setItem('config_visit', textConfig);
                }

                if (imageList) {
                    // Store the content of the images div in localStorage
                    const ImagesDiv = imageList.innerHTML;
                    localStorage.setItem('imagesDiv', ImagesDiv);
                }
            }
        });

        //==============================================================================
        // Get coordinates

        var lastClickCoord = null

        //Get coordinates of the mouse in pitch and yaw
        const panoramaView = document.getElementById("panorama");

        panoramaView.addEventListener("click", function (event) {
            lastClickCoord = null;
            lastClickCoord = pan.mouseEventToCoords(event)
        })


        //===============================================================================
        //Button add information

        const informationButton = document.getElementById("information");
        const popUp_Info = document.getElementById("hotspotInfoDesc");
        var closeInfoDesc = popUp_Info.getElementsByClassName("closeInfoDesc")[0];

        informationButton.onclick = function () {
            popUp_Info.classList.add("show");
        }

        // When the user clicks on the close button, hide the popup
        closeInfoDesc.onclick = function () {
            popUp_Info.classList.remove("show");
        }

        const infoText = document.getElementById("infoText");

        const submitButtonInfo = document.getElementById("submitButtonInfo");

        submitButtonInfo.addEventListener("click", function () {
            var hotspotInformation = {}
            hotspotInformation["id"] = hotspotID += 1;
            hotspotInformation["pitch"] = lastClickCoord[0];
            hotspotInformation["yaw"] = lastClickCoord[1];
            hotspotInformation["type"] = "info";
            hotspotInformation["text"] = infoText.value;
            hotspotInformation["clickHandlerFunc"] = myFunctionInformation;
            pan.addHotSpot(hotspotInformation, pan.getScene());
            infoText.value = "";
            popUp_Info.classList.remove("show");
        })

        //===============================================================================
        //Button add getway

        const gatewayButton = document.getElementById("gateway");
        const popUp_Gateway = document.getElementById("gatewayInfo");
        var closeGatewayInfo = popUp_Gateway.getElementsByClassName("closeGatewayInfo")[0];


        gatewayButton.addEventListener("click", function () {
            popUp_Gateway.classList.add("show");
        })

        closeGatewayInfo.onclick = function () {
            popUp_Gateway.classList.remove("show");
        }

        const sceneIdField = document.getElementById("endSceneId");
        const gatewayText = document.getElementById("gatewayText");
        const submitButton = document.getElementById("submitButton");


        /*Note : hotspotID is common to both gateway hotpots and information hotspots in order to delete them easily
        by calling the function removeHotspot */
        var hotspotID = 0;
        submitButton.addEventListener("click", function () {
            var hotspotGateway = {}
            hotspotGateway["id"] = hotspotID += 1;
            hotspotGateway["pitch"] = lastClickCoord[0];
            hotspotGateway["yaw"] = lastClickCoord[1];
            hotspotGateway["type"] = "scene";
            hotspotGateway["sceneId"] = sceneIdField.value;
            hotspotGateway["text"] = gatewayText.value;
            hotspotGateway["clickHandlerFunc"] = myFunctionGateway;
            pan.addHotSpot(hotspotGateway, pan.getScene());
            popUp_Gateway.classList.remove("show");
            sceneIdField.value = "";
            gatewayText.value = "";
        })



        //========================================================================================
        //Button delete

        var deletable = false;

        const deleteHotspotButton = document.getElementById("deleteHotspot");
        deleteHotspotButton.addEventListener("click", function () {
            if (deletable == false) {
                deletable = true;
                deleteHotspotButton.style.backgroundColor = '#ffcccb';
            }
            else {
                deletable = false;
                deleteHotspotButton.style.backgroundColor = '';
            }
        })

        function myFunctionInformation(event, handlerArgs) {
            if (deletable == true) {
                pan.removeHotSpot(this.id)
                deleteHotspotButton.style.backgroundColor = ""
                deletable = false;
            }
        }
        function myFunctionGateway(event, handlerArgs) {
            currentScene = pan.getScene();
            if (deletable) {
                this.sceneId = currentScene;
                pan.removeHotSpot(this.id);
                pan.loadScene(currentScene);
                deleteHotspotButton.style.backgroundColor = "";
                deletable = false;
            }
        }

        //=======================================================================================================
        //ADD a small circle on each image
        //=======================================================================================================

        const imageList = document.getElementById("image-list")
        // Get all the img elements on the imageList
        const images = imageList.getElementsByTagName('img');

        // Loop through each image and add a circle to its top left corner
        for (let i = 0; i < images.length; i++) {
            const img = images[i];
            const circle = document.createElement("circle");
            circle.style.width = '10px';
            circle.style.height = '80px';
            circle.style.borderRadius = '5px';
            circle.style.backgroundColor = 'red';
            circle.style.position = 'absolute';
            circle.style.top = '50%';
            circle.style.transform = 'translate(+10%, -50%)';
            img.parentNode.insertBefore(circle, img);
        }

        //=======================================================================================================
        const myOldImagesDiv = localStorage.getItem('imagesDiv');
        if (myOldImagesDiv) {
            imageList.innerHTML = myOldImagesDiv;
        }

        //Select one image
        let selectedImage = null;
        function selectImage(imageUrl) {
            if (selectedImage) {
                // Remove the selected class from the previously selected image
                selectedImage.classList.remove("selected");
            }
            // Set the selected image to the clicked image
            selectedImage = event.target;
            // Add the selected class to the clicked image
            selectedImage.classList.add("selected");
        }


        //=======================================================================================================
        //Button add panorama

        const AddPanoButton = document.getElementById("addPano");
        var popup_Panorma_info = document.getElementById("panoInfo");

        // Get the close button
        var closePano = popup_Panorma_info.getElementsByClassName("closePano")[0];

        AddPanoButton.onclick = function () {
            if (selectedImage == null) { // if no panorama is selected
                console.log("No panorama selected");
            } else {
                popup_Panorma_info.classList.add("show");
            }
        }

        // When the user clicks on the close button, hide the popup
        closePano.onclick = function () {
            popup_Panorma_info.classList.remove("show");
        }

        const IdsceneField = document.getElementById("endScenePano");
        const subButton = document.getElementById("submitButtonPano");

        //Add the scene with the panorama selected
        subButton.addEventListener("click", function () {
            if (selectedImage == null) { // if no panorama is selected
                console.log("No panorama selected");
            } else {
                var SceneInfo = {}
                SceneInfo["title"] = IdsceneField.value;
                SceneInfo["panorama"] = selectedImage.src;
                pan.addScene(SceneInfo.title, SceneInfo);
                sceneIdField.value = "";
                //Deselect the added panorama
                selectedImage.classList.remove("selected");
                //pan.loadScene(SceneInfo["title"]);
                selectedImage.title = IdsceneField.value;
                IdsceneField.value = null;
                //Set the associated small circle's color to green when adding a sceneId to the selected image
                selectedImage.parentNode.getElementsByTagName("circle")[0].style.backgroundColor = "#50C878"
                popup_Panorma_info.classList.remove("show");
            }
        })

        //=======================================================================================================
        //Button export
        //Export the Visit into a JSON file 
        const ExportButton = document.getElementById("ExportScene");

        ExportButton.addEventListener("click", function () {
            //Convert the visit into JSON
            var config = pan.getConfig();
            var partialConfig = {}
            partialConfig["default"] = config.default;
            partialConfig["scenes"] = config.scenes;
            var jsonFile = JSON.stringify(partialConfig);
            // Create a Blob object from the JSON string
            const blob = new Blob([jsonFile], { type: "application/json" });
            // Create a URL for the Blob object
            const url = URL.createObjectURL(blob);
            // Create a link element for downloading the file
            const link = document.createElement("a");
            link.href = url;
            link.download = "myData.json";
            // Add the link to the document and click it to download the file
            document.body.appendChild(link);
            link.click();
        })

        //=======================================================================================================
        //Button import visit

        const ImportButton = document.getElementById("importVisit");
        const popUpImport = document.getElementById("importVisitDesc");
        var closeImportInfo = popUpImport.getElementsByClassName("closeImportInfo")[0];

        ImportButton.addEventListener("click", function () {
            popUpImport.classList.add("show");
        })


        closeImportInfo.onclick = function () {
            popUpImport.classList.remove("show");
        }

        let selectedValue = null;

        let selectElement = document.querySelector('select');
        selectElement.addEventListener('change', function () {
            var selectedOption = selectElement.options[selectElement.selectedIndex];
            console.log(selectedOption.value);
            selectedValue = JSON.stringify(selectedOption.value);
            console.log(selectedValue);
        });

        const submitButtonImport = document.getElementById('submitButtonImport');

        submitButtonImport.addEventListener("click", function () {

            console.log(selectedValue);
            var jsonFilePath
            if (selectedValue == "Polytech") {
                console.log("je suis a polytech ");
                //Load and read the JSON file, then put it into a json object
                //===========================================================
                jsonFilePath = '../main/visit_polytech.json';

            } else if (selectedValue == "Fablab") {
                console.log("je suis au Fablab ");
                jsonFilePath = '../main/visit_Fablab.json';

            } else if (selectedValue == "Domus"){
                console.log("je suis au domus ");
                jsonFilePath = '../main/visit_domus.json';
            }

            // Read the JSON file and parse its contents
            const request = new XMLHttpRequest();
            request.open('GET', jsonFilePath, false);
            request.send(null);
            const jsonData = JSON.parse(request.responseText);
            //console.log(jsonString);
            //===========================================================

            //Destroy the previous visit
            pan.destroy();
            //Load the new one
            pan = pannellum.viewer('panorama', jsonData);
            var visit_to_import = null;
            popUpImport.classList.remove("show");

        });



        //=======================================================================================================
        //Button clear visit

        const ClearVisit = document.getElementById("clearVisit");

        ClearVisit.addEventListener("click", function () {
            pan.destroy();
            localStorage.clear();
            localStorage.setItem("goToZero", true)
            location.reload()
            localStorage.removeItem("goToZero")
        })


        //Button to switch to view mode
        function toggleMode() {
            window.location = "ViewMode.html";
        }
        //=======================================================================================================
        //Button to go to map edition, it will also store the content of the ImagesDiv
        function gotomap() {
            window.location = "EditionMap.html"
        }

    </script>

</body>

</html>