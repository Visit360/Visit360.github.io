<!DOCTYPE HTML>
<html>
<head>
    <title>DEMO</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.css"/>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.js"></script>
    <style>
        #panorama {
            width: 900px;
            height: 450px;
        }

        #console {
          background-color: lightgray;
          padding: 10px;
          width: 300px;
          height: 200px;
          overflow: auto;
        }

        .container {
            display: flex;
        }

        #miniMap {
        padding: 10px;
        width: 500px;
        height: 400px;
        overflow: auto;
        }
    </style>
</head>
<body>
    <!-- <iframe width="900" height="450" allowfullscreen style="border-style:none;" src="../../Pannellum/src/standalone/pannellum.htm?config=../../../Visit360/main/example_test.json"></iframe> -->
<!--     <div>Hello world!</div>-->    
<div class="container">
    <div class="first-child">
        <div id="panorama"></div>
        <div id = "buttons">
            <h2>Add Hotspots</h2>
            <button id="addScene">Add Scene</button>
            <button id="information">Add Information</button>
            <button id="gateway">Add Gateway</button>
            <button id="deleteHotspot">Delete Hotspot</button>
        </div>

        <div id="gatewayInfo" style="display: none;">
            <label for="name">Next Scene ID :</label>
            <input type="text" id="endSceneId" name="endSceneId" required>

            <label for="name">Gateway Text :</label>
            <input type="text" id="gatewayText" name="gatewayText" required>

            <button id="submitButton">Submit</button>
        </div>
        <div id="hotspotInfoDesc" style="display: none;">

            <label for="name">Description :</label>
            <input type="text" id="infoText" name="infoText" required>

            <button id="submitButtonInfo">Submit</button>
        </div>

        <br>

        <div id="History">
            <button id="console-toggle">Show History</button>
            <div id="console" style="display: none;">
                <button id="clear-history">Clear History</button>
                <div id="console-content"></div>
            </div>
        </div>
    </div>

    <div class="second-child">
        <h2>HELLO MOTHERFUCKER</h2>
        <div id="miniMap">
            <img src="../content/panorama/Plan-maison-etage.jpg" alt="Plan de masse" width="100%" height="98%">
        </div>
        <div >
            <button id="mode-button">Go to View Mode</button>
            <div id="add-scene-form" style="display: none;">
                <label for="name">Scene To associate :</label>
                <input type="text" id="sceneAssociated" name="sceneAssociated" required>
                <button id="add-scene-map">Add scene to the map</button>
            </div>
        </div>
    </div>
</div>

    <script>

    var initialConfig = 
        {
            "default": {
               "firstScene": "nature",
               "sceneFadeDuration": 2000,
               "hotSpotDebug" : true
            },

            "scenes": {
                "nature": {
                "title": "Nature",
                "panorama": "../content/panorama/examplepano.jpg",
                },
            }  
        }

    var hotspotInformation = {
        "pitch" : 0,
        "yaw" : 100,
        "type" : "info",
        "text" : "This is nature"
    }
    

        var scene_Polytech = {
            "title": "Polytech",
            "panorama": "../content/panorama/HALL.jpg",
            "hotSpots": [
                {
                    "pitch": -10,
                    "yaw": -50,
                    "type": "info",
                    "text": "Ceci est le Hall de Polytech"
                }, 
                {
                    "pitch": 0,
                    "yaw": -100,
                    "type": "scene",
                    "text": "Nature",
                    "sceneId": "nature",
                }
            ]
        }
    
    
        //loadScene(sceneId, targetPitch, targetYaw, targetHfov, fadeDone)
        var pan = pannellum.viewer('panorama', initialConfig);
        //pan.addHotSpot(hsi,'imag'); //ajouter un hotspot d'information
        //pan.removeScene('nature'); //supprimer une sc√®ne
        //console.log(pannellum.viewer('panorama', config2).getConfig())
        //pan.addHotSpot(hsp, 'nature');
/*         pan = pan.addScene("POLYTECH", scene_Polytech)
        console.log(pan.getConfig()) */

        const sceneButton = document.getElementById("addScene");
        const informationButton = document.getElementById("information");
        const gatewayButton = document.getElementById("gateway");
    
        

        sceneButton.addEventListener("click", function(){
            console.log("you added a scene")
            pan = pan.addScene("polytech", scene_Polytech);

        })

/*         informationButton.addEventListener("click", function(){

            console.log("you added an information")
            pan.addHotSpot(hotspotInformation, 'nature');

        }) */
/*         gatewayButton.addEventListener("click", function(){
            console.log("you added a gateway")
            pan.addHotSpot(hotspotGateway, 'nature');
        }) */

        var lastClickCoord = null

        //Get coordinates of the mouse in pitch and yaw
        const panoramaView = document.getElementById("panorama");
        
        panoramaView.addEventListener("click", function(event){
            lastClickCoord = null;
            //console.log(pan.mouseEventToCoords(event));
            lastClickCoord = pan.mouseEventToCoords(event)
        })

        
        const gatewayAddDiv = document.getElementById("gatewayInfo");
        gatewayButton.addEventListener("click", function(){
                gatewayAddDiv.style.display = "block";
        })


        const informationAddDiv = document.getElementById("hotspotInfoDesc");
        informationButton.addEventListener("click", function(){
            informationAddDiv.style.display = "block";
        })
        
        const sceneIdField = document.getElementById("endSceneId");
        const gatewayText = document.getElementById("gatewayText");
        const submitButton = document.getElementById("submitButton");

        const infoText = document.getElementById("infoText");
        const submitButtonInfo = document.getElementById("submitButtonInfo");
        
        /*Note : hotspotID is common to both gateway hotpots and information hotspots in order to delete them easily
        by calling the function removeHotspot */
        var hotspotID = 0;
        submitButton.addEventListener("click", function(){
            var hotspotGateway = {}
            hotspotGateway["id"] = hotspotID+=1;
            hotspotGateway["pitch"] = lastClickCoord[0];
            hotspotGateway["yaw"] = lastClickCoord[1];
            hotspotGateway["type"] = "scene";
            hotspotGateway["sceneId"] = sceneIdField.value;
            hotspotGateway["text"] = gatewayText.value;
            hotspotGateway["clickHandlerFunc"] = myFunctionGateway;
            hotspotGateway["clickHandlerArgs"] = pan.getScene()
            pan.addHotSpot(hotspotGateway, pan.getScene());
            console.log("you added a gateway");
            gatewayAddDiv.style.display = "none";
            sceneIdField.value = "";
            gatewayText.value = "";
/*             console.log(hotspotGateway)
            console.log(JSON.stringify(hotspotGateway));
            console.log(pan.getConfig()); */
        })


        submitButtonInfo.addEventListener("click", function(){
            var hotspotInformation={}
            hotspotInformation["id"] = hotspotID+=1;
            hotspotInformation["pitch"] = lastClickCoord[0];
            hotspotInformation["yaw"] = lastClickCoord[1];
            hotspotInformation["type"] = "info";
            hotspotInformation["text"] = infoText.value;
            hotspotInformation["clickHandlerFunc"] = myFunctionInformation;
            pan.addHotSpot(hotspotInformation, pan.getScene());
            console.log("you added an information")
            informationAddDiv.style.display = "none";
            infoText.value = "";
            console.log(hotspotInformation)
            console.log(JSON.stringify(hotspotInformation));
            console.log(pan.getConfig());
            console.log(pan.getScene());
        })
        
        var deletable = false;

        const deleteHotspotButton = document.getElementById("deleteHotspot");
        deleteHotspotButton.addEventListener("click", function(){
            if(deletable == false){
                deletable = true;
                deleteHotspotButton.style.backgroundColor='#ffcccb';
            }
            else{
                deletable = false;
                deleteHotspotButton.style.backgroundColor='';
            }
        })

        function myFunctionInformation(event, handlerArgs) {
            if(deletable == true){
                pan.removeHotSpot(this.id)
                console.log("Hotspot removed")
                deleteHotspotButton.style.backgroundColor = ""
                deletable = false;
            }
        }

        var visitHistory=[];
        //History of the scenes that will be printed in the html
        var historyHtml = "";

        var currentScene = null

        function myFunctionGateway(event, handlerArgs) {
            currentScene = pan.getScene();
            if (deletable) {
                this.sceneId = currentScene;
                console.log(this)
                console.log(currentScene);
                pan.removeHotSpot(this.id);
                pan.loadScene(currentScene);
                console.log("Hotspot removed");
                deleteHotspotButton.style.backgroundColor = "";
                deletable = false;
            } else {
                //console.log(handlerArgs);
                visitHistory.push(handlerArgs);
                historyHtml += "<a href='#' onclick='handleHistoryClick(\"" + handlerArgs + "\")'> Visit " + handlerArgs + "</a><br>";
                consoleContent.innerHTML = historyHtml;
            }
            console.log("You clicked the gateway. Before clicking, you were at " + currentScene);
            console.log(pan.getConfig());
        }
        function handleHistoryClick(handlerArgs) {
            // Code to execute when the link is clicked
            console.log("Link clicked!");
            console.log(handlerArgs)
            pan.loadScene(handlerArgs)

        }


        const toggleButton = document.getElementById("console-toggle");
        const consoleElement = document.getElementById("console");
        const consoleContent = document.getElementById("console-content");
        const clearHistory = document.getElementById("clear-history");

        //toggleButton is the Hide/show history button
        toggleButton.addEventListener("click", function() {
        if (consoleElement.style.display === "none") {
            consoleElement.style.display = "block";
            toggleButton.innerHTML = "Hide History";
        } else {
            consoleElement.style.display = "none";
            toggleButton.innerHTML = "Show Hitory";
        }
        });

        clearHistory.addEventListener("click", function(){
            visitHistory = [];
            historyHtml = "";
            consoleContent.innerHTML = "";
        })

//-------------------------------------------------------------------------------------
//-------------------------------------------------------------------------------------
        //MINIMAP CODE 
//-------------------------------------------------------------------------------------
//-------------------------------------------------------------------------------------

        const miniMap = document.getElementById("miniMap");
        const modeButton = document.getElementById("mode-button");
        const addAssociatedSceneForm = document.getElementById("add-scene-form")
        const sceneAssociated = document.getElementById("sceneAssociated");
        const addSceneOnMApButton = document.getElementById("add-scene-map")

        var lastCreatedCircle = null

        addSceneOnMApButton.addEventListener("click", function(e, arg){
            if(lastCreatedCircle){
                lastCreatedCircle.name = sceneAssociated.value
            }
            sceneAssociated.value = ""
            addAssociatedSceneForm.style.display = "none"
        })
        
        function createCircle(){
            const circle = document.createElement("circle");
            circle.style.width = "20px";
            circle.style.height = "20px";
            circle.style.borderRadius = "10px";
            circle.style.position = "absolute";
            circle.style.zIndex = 1;
            return circle;
        }
        var mapClickHandler = function(event) {
                var circle = createCircle();
                circle.style.backgroundColor = "red";
                circle.style.left = event.clientX + "px";
                circle.style.top = event.clientY + "px";
                miniMap.appendChild(circle);
                setDeletionListener(circle);
                lastCreatedCircle = circle
                addAssociatedSceneForm.style.display = "block";
        };
        var Hovercircle = createCircle();
        var mapHoverHandler = function(event){
            Hovercircle.style.backgroundColor = "red";
            Hovercircle.style.left = event.clientX + "px";
            Hovercircle.style.top = event.clientY + "px";
            Hovercircle.style.opacity = 0.5;
            miniMap.appendChild(Hovercircle)
        };

        function setMapListener(){
            miniMap.addEventListener("click", mapClickHandler);
            miniMap.addEventListener("mousemove", mapHoverHandler);
        }

        function unsetMapListener(){
            miniMap.removeEventListener("click", mapClickHandler);
            miniMap.removeEventListener("mousemove", mapHoverHandler);
        }

        var lastSelectedCircle;

        function circleClickHandler(circle) {
            if (mode == "View") {
                if (lastSelectedCircle) {
                    lastSelectedCircle.style.backgroundColor = "red";
                }
            circle.style.backgroundColor = "green";
            lastSelectedCircle = circle;
            pan.loadScene(circle.name)
            }
        }

        function setCirclesListener(){
            var circles = miniMap.querySelectorAll("circle");
            if(circles){
                for (const circle of circles) {
                    circle.addEventListener("click", function() {
                        circleClickHandler(circle);}
                    );
                }
            };
        }


        function unsetCirclesListener(){
            var circles = miniMap.querySelectorAll("circle");
            if(circles){
                for (const circle of circles) {
                    circle.removeEventListener("click", function() {
                        circleClickHandler(circle);}
                    )
                }
            }
        };

        function deletionHandler(event) {
            event.preventDefault();
            // Remove the circle from the DOM
            event.target.remove();
        }


        function setDeletionListener(circle) {
            if (circle) {
                circle.addEventListener('contextmenu', deletionHandler);
            }
        }


        function unsetDeletionListenerOnAll() {
            var circles = miniMap.querySelectorAll("circle");
            if (circles) {
                circles.forEach(circle => {
                circle.removeEventListener('contextmenu', deletionHandler);
                });
            }
        }

        function setDeletionListenerOnAll(){
            var circles = miniMap.querySelectorAll("circle");
            if(circles){
                circles.forEach(circle=>setDeletionListener(circle))
            }
        }

        var mode = "Edition"
        if (miniMap) {
            setMapListener();
            //setDeletionListener();
        }
        unsetCirclesListener()
        console.log(document.getElementsByTagName("h2")[1].innerHTML);
        modeButton.addEventListener("click", function() {
            if (mode == "Edition") {
                mode = "View";
                document.getElementsByTagName("h2")[1].innerHTML = "You're in the View Mode";
                
                modeButton.innerHTML = "Go to Edition Mode";
                unsetDeletionListenerOnAll();
                unsetMapListener();
                setCirclesListener();
                Hovercircle.style.opacity = 0;
                addAssociatedSceneForm.style.display = "none"

            } else {
                mode = "Edition";
                document.getElementsByTagName("h2")[1].innerHTML = "You're in the Edition Mode";
                modeButton.innerHTML = "Go to View Mode";
                unsetCirclesListener();
                setMapListener();
                setDeletionListenerOnAll()
            }
        });
            

    </script>
            
</body>
</html>