<!DOCTYPE HTML>
<html>

<head>
    <title>Edition mode Visit360</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.css" />
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.js"></script>
    <style>
        html,body{
            font-family: 'Trebuchet MS';
			background-color: rgb(51, 51, 51);
			color: white;
            display: block;
            height: 100vh;
            box-sizing: border-box;
            overflow: hidden;
        }
        .child1{
			display: flex;
   			height:75px;
    		width: 100%;
    		
		}
        .child2{
            display: flex;
            height: calc(100vh - 80px);
        }
        #button{
            width: 75px;
            height: 75px;
        }
		
        #header{
            background: rgb(59, 59, 59);
            width: 100%;
            padding-left: 20px;
            border-radius: 5px;
        }
        
        #viewer{
            width: 100%;

        }

   

        .scroller {
            width: 255px;
            height: calc(100vh - 80px);
            overflow-y: scroll;
            scrollbar-color: rgb(0, 255, 221) rgb(0, 255, 221);
            scrollbar-width: thin;
            
        }

        #selection{
            background-color: grey;

            width: 255px;
            
        }

        .selected {
            border: 3px solid rgb(0, 255, 221);
        }

        #toolbar{
            background-color: grey;
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 400px;
            height:100%;
        } 
        #buttons{
            display: flex;
            flex-direction: column;
            row-gap: 25px;
            width:70%;
            padding: 25px;
        }
        .button{
            background-color: rgb(0, 255, 221);
            border: none;
            font-size: medium;
            border-radius: 5px;
            padding: 5px;
           
        }
        .input{
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-size: medium;
            border-radius: 5px;
            
        }
        .label{
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-size: medium;
            
            
        }
    </style>
</head>

<body>
    <div id="child1" class="child1">
        <div id="button">
		    <button style="width:75px;height:75px;font-size:50px;background-color: rgb(0, 255, 221);border: none;border-radius: 5px;" onclick="toggleMode()">&#128065;</button>
        </div>
        <div id="header">
	        <h1>Edit Visit360</h1>
        </div>
	</div>
    <div id="child2" class="child2">
        <div id="selection" class="column">
            <div class="scroller">
                <div id="image-list">
                    <img src="../content/panorama/amphi_005.jpg" alt="amphi_005" width="240" height="100"
                        onclick="selectImage('amphi_005')">
                    <img src="../content/panorama/amphi_007.jpg" alt="amphi_007" width="240" height="100"
                        onclick="selectImage('amphi_007')">
                    <img src="../content/panorama/couloir_1.jpg" alt="couloir_1" width="240" height="100"
                        onclick="selectImage('couloir_1')">
                    <img src="../content/panorama/couloir_2.jpg" alt="couloir_2" width="240" height="100"
                        onclick="selectImage('couloir_2')">
                    <img src="../content/panorama/couloir_3.jpg" alt="couloir_3" width="240" height="100"
                        onclick="selectImage('couloir_3')">
                    <img src="../content/panorama/couloir_4.jpg" alt="couloir_4" width="240" height="100"
                        onclick="selectImage('couloir_4')">
                    <img src="../content/panorama/couloir_5.jpg" alt="couloir_5" width="240" height="100"
                        onclick="selectImage('couloir_5')">
                    <img src="../content/panorama/couloir_6.jpg" alt="couloir_6" width="240" height="100"
                        onclick="selectImage('couloir_6')">
                    <img src="../content/panorama/Hall.jpg" alt="Hall" width="240" height="100"
                        onclick="selectImage('Hall')">
                    <img src="../content/panorama/salle_009.jpg" alt="salle_009" width="240" height="100"
                        onclick="selectImage('salle_009')">
                    <img src="../content/panorama/salle_013.jpg" alt="salle_013" width="240" height="100"
                        onclick="selectImage('salle_013')">
                </div>
            </div>
        </div>
        <div id="viewer" class="column">
            <div id="panorama"></div>       
        </div>

        <div id="toolbar"class="column">
            <div id="buttons">
                <button id="addPano" class="button">Add Panorama</button>
                <button id="information" class="button">Add Information</button>
                <button id="gateway" class="button">Add Gateway</button>
                <button id="deleteHotspot" class="button">Delete Hotspot</button>
                <button id="ExportScene" class="button">Export Scene</button>
                <button id="importVisit" class="button">Import Visit</button>
            </div>
            
            <div id="panoInfo" style="display: none;">
                <label for="name" class="label">Scene ID :</label>
                <input type="text" id="endScenePano" name="endScenePano" class="input" required>
                <button id="submitButtonPano" class="button">Submit</button>
            </div>

            <div id="gatewayInfo" style="display: none;">
                <label for="name" class="label">Next Scene ID :</label>
                <input type="text" id="endSceneId" name="endSceneId" class="input" required>

                <label for="name" class="label">Gateway Text :</label>
                <input type="text" id="gatewayText" name="gatewayText" class="input" required>

                <button id="submitButton" class="button">Submit</button>
            </div>
            <div id="hotspotInfoDesc" style="display: none;">

                <label for="name" class="label">Description :</label>
                <input type="text" id="infoText" name="infoText" class="input" required>

                <button id="submitButtonInfo" class="button">Submit</button>
            </div>
            
        </div>
    
    </div>

    <script>

        var initialConfig =
        {
            "default": {
                "firstScene": "nature",
                "sceneFadeDuration": 2000,
                "hotSpotDebug": true
            },

            "scenes": {
                "nature": {
                    "title": "Nature",
                    "panorama": "../content/panorama/examplepano.jpg",
                },
            },
            
            "autoLoad":true
        }

        var hotspotInformation = {
            "pitch": 0,
            "yaw": 100,
            "type": "info",
            "text": "This is nature"
        }


        var scene_Polytech = {
            "title": "Polytech",
            "panorama": "../content/panorama/Hall.jpg",
            "hotSpots": [
                {
                    "pitch": -10,
                    "yaw": -50,
                    "type": "info",
                    "text": "Ceci est le Hall de Polytech"
                },
                {
                    "pitch": 0,
                    "yaw": -100,
                    "type": "scene",
                    "text": "Nature",
                    "sceneId": "nature",
                }
            ]
        }


        var pan = pannellum.viewer('panorama', initialConfig);

        const informationButton = document.getElementById("information");
        const gatewayButton = document.getElementById("gateway");

        var lastClickCoord = null

        //Get coordinates of the mouse in pitch and yaw
        const panoramaView = document.getElementById("panorama");

        panoramaView.addEventListener("click", function (event) {
            lastClickCoord = null;
            lastClickCoord = pan.mouseEventToCoords(event)
        })


        const gatewayAddDiv = document.getElementById("gatewayInfo");
        gatewayButton.addEventListener("click", function () {
            gatewayAddDiv.style.display = "block";
        })


        const informationAddDiv = document.getElementById("hotspotInfoDesc");
        informationButton.addEventListener("click", function () {
            informationAddDiv.style.display = "block";
        })

        const sceneIdField = document.getElementById("endSceneId");
        const gatewayText = document.getElementById("gatewayText");
        const submitButton = document.getElementById("submitButton");

        const infoText = document.getElementById("infoText");
        const submitButtonInfo = document.getElementById("submitButtonInfo");

        /*Note : hotspotID is common to both gateway hotpots and information hotspots in order to delete them easily
        by calling the function removeHotspot */
        var hotspotID = 0;
        submitButton.addEventListener("click", function () {
            var hotspotGateway = {}
            hotspotGateway["id"] = hotspotID += 1;
            hotspotGateway["pitch"] = lastClickCoord[0];
            hotspotGateway["yaw"] = lastClickCoord[1];
            hotspotGateway["type"] = "scene";
            hotspotGateway["sceneId"] = sceneIdField.value;
            hotspotGateway["text"] = gatewayText.value;
            hotspotGateway["clickHandlerFunc"] = myFunctionGateway;
            pan.addHotSpot(hotspotGateway, pan.getScene());
            gatewayAddDiv.style.display = "none";
            sceneIdField.value = "";
            gatewayText.value = "";
        })


        submitButtonInfo.addEventListener("click", function () {
            var hotspotInformation = {}
            hotspotInformation["id"] = hotspotID += 1;
            hotspotInformation["pitch"] = lastClickCoord[0];
            hotspotInformation["yaw"] = lastClickCoord[1];
            hotspotInformation["type"] = "info";
            hotspotInformation["text"] = infoText.value;
            hotspotInformation["clickHandlerFunc"] = myFunctionInformation;
            pan.addHotSpot(hotspotInformation, pan.getScene());
            informationAddDiv.style.display = "none";
            infoText.value = "";
        })

        var deletable = false;

        const deleteHotspotButton = document.getElementById("deleteHotspot");
        deleteHotspotButton.addEventListener("click", function () {
            if (deletable == false) {
                deletable = true;
                deleteHotspotButton.style.backgroundColor = '#ffcccb';
            }
            else {
                deletable = false;
                deleteHotspotButton.style.backgroundColor = '';
            }
        })

        function myFunctionInformation(event, handlerArgs) {
            if (deletable == true) {
                pan.removeHotSpot(this.id)
                deleteHotspotButton.style.backgroundColor = ""
                deletable = false;
            }
        }
        function myFunctionGateway(event, handlerArgs) {
            currentScene = pan.getScene();
            if (deletable) {
                this.sceneId = currentScene;
                pan.removeHotSpot(this.id);
                pan.loadScene(currentScene);
                deleteHotspotButton.style.backgroundColor = "";
                deletable = false;
            }
        }



        //=======================================================================================================
        //Select one image
        let selectedImage = null;
        function selectImage(imageUrl) {
            if (selectedImage) {
                // Remove the selected class from the previously selected image
                selectedImage.classList.remove("selected");
            }
            // Set the selected image to the clicked image
            selectedImage = event.target;
            // Add the selected class to the clicked image
            selectedImage.classList.add("selected");
        }


        //=======================================================================================================
        //Button add panorama

        const AddPanoButton = document.getElementById("addPano");

        const PanoAddDiv = document.getElementById("panoInfo");
        AddPanoButton.addEventListener("click", function () {
            PanoAddDiv.style.display = "block";
        })

        const IdsceneField = document.getElementById("endScenePano");
        const subButton = document.getElementById("submitButtonPano");


        //Add the scene with the panorama selected
        subButton.addEventListener("click", function () {
            if (selectedImage == null) { // if no panorama is selected
                PanoAddDiv.style.display = "none";
            } else {
                var SceneInfo = {}
                SceneInfo["title"] = IdsceneField.value;
                SceneInfo["panorama"] = selectedImage.src;
                pan.addScene(SceneInfo.title, SceneInfo);
                PanoAddDiv.style.display = "none";
                sceneIdField.value = "";
                //Deselect the added panorama
                selectedImage.classList.remove("selected");
                //pan.loadScene(SceneInfo["title"])
            }
        })


        //=======================================================================================================
        //Button export
        //Export the Visit into a JSON file 
        const ExportButton = document.getElementById("ExportScene");

        ExportButton.addEventListener("click", function () {
            //Convert the visit into JSON
            var config = pan.getConfig();
            var partialConfig = {}
            partialConfig["default"] = config.default;
            partialConfig["scenes"] = config.scenes;
            var jsonFile = JSON.stringify(partialConfig);
            // Create a Blob object from the JSON string
            const blob = new Blob([jsonFile], { type: "application/json" });
            // Create a URL for the Blob object
            const url = URL.createObjectURL(blob);
            // Create a link element for downloading the file
            const link = document.createElement("a");
            link.href = url;
            link.download = "myData.json";
            // Add the link to the document and click it to download the file
            document.body.appendChild(link);
            link.click();
        })

        //=======================================================================================================
        //Button import visit 
        //Button import visit
        const ImportButton = document.getElementById("importVisit");

        ImportButton.addEventListener("click", function () {
            //Load and read the JSON file, then put it into a json object
            //===========================================================
            const jsonFilePath = '../content/visit/example_test.json';
            // Read the JSON file and parse its contents
            const request = new XMLHttpRequest();
            request.open('GET', jsonFilePath, false);
            request.send(null);
            const jsonData = JSON.parse(request.responseText);
            //console.log(jsonString);
            //===========================================================

            //Destroy the previous visit
            pan.destroy();
            //Load the new one
            //pan = pannellum.viewer('panorama', jsonString)
            pan = pannellum.viewer('panorama', jsonData);
        })
        function toggleMode() {
            window.location="ViewMode.html";
		}
		
    </script>

</body>

</html>